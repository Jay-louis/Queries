select order_number, item_number, order_qty, picked_qty, order_qty - picked_qty qty_needed, pm_qty, bs_qty, scrb_qty, stg_qty,
pm_qty + bs_qty + scrb_qty + stg_qty total_qty from
(select o.order_number,
 d.item_number, 
 count(d.qty) order_qty, 
 sum(p.picked_quantity) picked_qty,
 isnull((
  SELECT sum(isnull(pm.actual_qty,0)) AS pm_qty
  FROM t_stored_item pm (nolock)
  WHERE type = '0'  
  AND (location_id LIKE 'AA%' OR location_id LIKE 'AB%' OR location_id LIKE 'AC%' OR location_id LIKE 'AD%') 
  AND pm.item_number = d.item_number
  GROUP BY item_number
 ), 0) pm_qty,
 isnull((
  SELECT sum(isnull(actual_qty,0)) AS bs_qty
  FROM t_stored_item bs (nolock)
  WHERE type = '0' 
  AND (location_id LIKE 'BS%')
  AND bs.item_number = d.item_number
  GROUP BY item_number
 ),0) bs_qty,
 isnull((
  SELECT sum(isnull(actual_qty,0)) AS scrb_qty
  FROM t_stored_item scrb (nolock)
  WHERE type = '0' 
  AND (location_id LIKE 'SC%'
  OR location_id LIKE 'SV%'
  OR location_id LIKE 'RB%') 
  AND scrb.item_number = d.item_number
 GROUP BY item_number
 ),0) scrb_qty,
 isnull((
  SELECT sum(isnull(actual_qty,0)) AS stg_qty
  FROM t_stored_item stg (nolock)
  WHERE type = '0' 
  AND (location_id LIKE 'CP%'
  OR location_id LIKE 'OS%'
  OR location_id LIKE 'RCV%'
  OR location_id LIKE 'RESTOCKER%'
  OR location_id LIKE 'CART%'
  OR location_id LIKE 'SFS%'
  OR location_id LIKE 'REC%'
  OR location_id LIKE 'TRANS%'
  OR location_id LIKE 'INV%'
  OR location_id LIKE '[1-9]%'
  OR location_id LIKE 'RIM%'
  OR location_id LIKE 'SEV%')
  AND stg.item_number = d.item_number
  GROUP BY item_number
 ),0) stg_qty
from t_order o (nolock)
join t_order_detail d (nolock) on d.order_number = o.order_number
join t_pick_detail p (nolock) on p.order_number = o.order_number and p.line_number = d.line_number and p.item_number = d.item_number and p.status not in ('CANCELLED')
where cast(order_date as date) >= '2020-08-10' and o.status NOT IN ('SHIPPED','CANCELLED','PACKED','LOADED','S', 'PROCESSING', 'SHIPPING') 
--and wcs_status in ('R', 'M', 'P', 'S', 'C', 'A')
group by o.order_number, d.item_number) a
where (pm_qty + bs_qty + scrb_qty + stg_qty) = 0 and (order_qty - picked_qty) > 0
order by item_number, order_number
