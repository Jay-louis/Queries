--pending old order details -- need pick mod inventory -- need to seperate bulk from pickmod inv -- Updated 06.28.2020
select CAST(orm.order_date as date) "Order Date", orm.order_number, det.item_number, det.qty, isnull(inv.inventory,0) as "Ttl INV", ISNULL(bs.BulkInv, 0) as "BS Inv", ISNULL(scrb.SC_RBInv, 0) as "SC/RB INV",
	   isnull(pm.PickInv,0) as PMInv --pick.order_number, pick.item_number, 
	   ,isnull(pick.status, 'Imported') as Pickstatus, pick.NotPicked
from t_order_detail det (nolock)
join t_order orm(nolock)
on det.order_number = orm.order_number

--subquery (pick)
left outer join (
    select pic.order_number, pic.item_number, sum(planned_quantity - picked_quantity) as NotPicked, pic.status
    from t_pick_detail pic(nolock)
    GROUP BY pic.order_number, pic.item_number, pic.status
    )pick
    ON det.order_number = pick.order_number
    AND det.item_number = pick.item_number

--subquery 2 (total inventory)   
left outer join (
    select sum(sto.actual_qty) as inventory, sto.item_number
    from t_stored_item sto(nolock)
    where sto.type = '0'
    --and sto.status = 'A'
    GROUP BY sto.item_number
    )inv
on det.item_number = inv.item_number

--subquery (pickmod)
LEFT OUTER JOIN(
SELECT item_number, sum(isnull(actual_qty,0)) AS PickInv
FROM t_stored_item (nolock)
WHERE type = '0' 
AND (location_id LIKE 'AA%' OR location_id LIKE 'AB%' OR location_id LIKE 'AC%' OR location_id LIKE 'AD%') 
--AND status = 'A' 
--AND item_number = '827088'
GROUP BY item_number
) pm
ON det.item_number = pm.item_number

--subquery (bulk BS)
LEFT OUTER JOIN(
SELECT item_number, sum(isnull(actual_qty,0)) AS "BulkInv"
FROM t_stored_item (nolock)
WHERE type = '0' 
AND (location_id LIKE 'BS%') 
--AND status = 'A' 
--AND item_number = '827088'
GROUP BY item_number
) bs
ON det.item_number = bs.item_number

--subquery (bulk SEV/RIM)
LEFT OUTER JOIN(
SELECT item_number, sum(isnull(actual_qty,0)) AS "SC_RBInv"
FROM t_stored_item (nolock)
WHERE type = '0' 
AND (location_id LIKE 'SC%'
OR location_id LIKE 'SV%'
OR location_id LIKE 'RB%') 
--AND status = 'A' 
--AND item_number = '827088'
GROUP BY item_number
) scrb
ON det.item_number = scrb.item_number

WHERE orm.status NOT IN ('SHIPPED','CANCELLED','PACKED','LOADED','S')
      AND orm.order_type NOT IN ('RT','RTV','SM')
      --AND orm.order_number = '55018185'
      AND CAST(orm.order_date as date) <= '2020-06-26' -- update date focusing on
      --AND cast(orm.order_date as date) > getdate() - 5
      --AND det.item_number = '665190'
GROUP BY orm.order_date, orm.order_number, det.item_number, det.qty, isnull(inv.inventory,0), pick.order_number, pick.item_number, pick.status, pick.NotPicked, pm.PickInv, bs.BulkInv
	    ,scrb.SC_RBInv
ORDER BY orm.order_number
